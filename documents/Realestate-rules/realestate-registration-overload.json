{
    "trigger": {
        "schedule": {
            "interval": "1m"
        }
    },
    "input": {
        "search": {
            "request": {
                "body": {
                    "size": 0,
                    "query": {
                        "bool": {
                            "must": [
                                {
                                    "match_phrase": {
                                        "action": "REGISTRATION"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "logmessage": "succesfully registered"
                                    }
                                }
                            ],
                            "filter": [{
                                "range": {
                                    "@timestamp": {
                                        "gte": "now-30m"
                                    }
                                }
                            }]
                        }
                    }
                },
                "indices": [
                    "appbeat-*"
                ]
            }
        }
    },
    "condition": {
        "compare": {
            "ctx.payload.hits.total": {
                "gte": 100
            }
        }
    },
    "actions": {
        "my-logging-action": {
            "logging": {
                "text": "[RULE TRIGGERED] Too many registrations in last half hour. {{ctx.payload.hits.total}} users registered."
            }
        },
        "index_payload" : { 
            "transform": {
                    "script" : {
                    "lang" : "painless",
                    "inline" : "def alarms = []; for (int i = 0; i < ctx.payload.hits.hits.length; ++i){ def source = ctx.payload.hits.hits[i]._source; source.timestamp = ctx.execution_time; alarms.add(source); } return ['_doc' : alarms];" 
                    }
                },
            "index" : {
                "index" : "<alarms-{now/d{YYYY.MM.dd|+01:00}}>", 
                "doc_type" : "realestate",
                "execution_time_field" : "timestamp"  
            }
        },  
        "send_email" : {
            "email" : {
                "to" : "cobrijani@gmail.com",
                "subject" : "Alarm for realestate!",
                "body" : "Too many registrations in last half hour. {{ctx.payload.hits.total}} users registered.",
                "priority" : "high"
            }
        }
    }
}
